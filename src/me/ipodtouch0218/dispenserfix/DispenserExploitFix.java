package me.ipodtouch0218.dispenserfix;

import org.bukkit.Bukkit;
import org.bukkit.Location;
import org.bukkit.Material;
import org.bukkit.block.Block;
import org.bukkit.block.BlockFace;
import org.bukkit.block.Dispenser;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.block.BlockPhysicsEvent;
import org.bukkit.plugin.java.JavaPlugin;

public class DispenserExploitFix extends JavaPlugin implements Listener {

	private static final int[][] OFFSETS = {{1,-1,0},{-1,-1,0},{0,-1,1},{0,-1,-1}};
	
	@Override
	public void onEnable() {
		Bukkit.getPluginManager().registerEvents(this, this);
	}

	@EventHandler(priority=EventPriority.HIGHEST,ignoreCancelled=true)
	public void onDispenserShoot(BlockPhysicsEvent e) {
		if (!(e.getBlock().getState() instanceof Dispenser))
			return;
		Block block = e.getBlock();
		Dispenser dispenser = (Dispenser) block.getState();
		if (((org.bukkit.block.data.type.Dispenser) dispenser.getBlockData()).getFacing() != BlockFace.DOWN)
			return;
		if (!block.getRelative(0,-1,0).isEmpty())
			return;
		if (block.getRelative(0,-2,0).getType().isFlammable())
			return;
		for (int[] offset : OFFSETS) {
			if (block.getRelative(offset[0], offset[1], offset[2]).getType() == Material.OBSIDIAN) {
				e.setCancelled(true);
				Location loc = block.getLocation();
				System.out.println("Someone's trying to crash the server @ " + loc.getWorld().getName() + ", " + loc.getBlockX() + ", " + loc.getBlockY() + ", " + loc.getBlockZ());
				return;
			}
		}
	}
	
}
